---
title: "NYC Bike Analysis"
author: "Lauren Davidson"
date: "18/01/2021"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

# Introduction to the data
A dataset sourced from New York Citi Bikes made available via the open source Tsibble Data package.
The dataset contains the rental information of 10 bikes throughout 2018.
It is important to consider whether these journeys are representative of overall Citi bike usage. We know that the data has been processed to remove non-representative data such as rides taken by members of Citi Bike staff or 'false start' journeys lasting less than 60 seconds. If we assume that the 10 bikes have been selected at random, then tracking 10 of the Citi Bike's fleet of 15,000 bike should provide a useful cross-section of use. Though we might find that these bikes are not used evenly across the entire city as their location is dependent on customer usage. A larger sample would provide stronger evidence.
While we have access to the start and end point of the journey and the customer's birth year and gender, we will not be able to identify individual users, so there is no concern about privacy. Indeed, attempting to identify individual users is prohibited under the Citi Bike Data License Agreement.

```{r}
library(tsibbledata)
library(tsibble)
library(tidyverse)
library(lubridate)
library(slider)

nyc_bikes <- nyc_bikes %>% 
  filter(birth_year > 1900)
theme_set(theme_minimal())
# Zero=unknown; 1=male; 2=female
```


# Analysis Questions

#### What is the pattern of bike hires over time (e.g. within a year, month, week, or day)?

```{r}
nyc_bikes <- nyc_bikes %>% 
  mutate(month = month(start_time, label = T),
         week = week(start_time),
         day = day(start_time)
         )
```
```{r}
# Box plot by month
nyc_bikes %>% 
  ggplot() +
  geom_histogram(aes(x = month), bins = 12, stat = "count", fill = "steel blue") +
  labs(
    title = "2018 Bike use by month",
    x = "Month",
    y = "Number of rentals"
  )
```

This plot shows us that bike usage rises during the summer months, peaking in August and declines in winter with bike usage at their lowest levels in December. We notice a possible spike in usage duing January which may be accounted for by New Year's resolutions.

This information can be used by Citi Bikes to increase advertising in months where we see a decline in usage - February, November and Decembe.
Citi Bikes could also consider how they can have the largest possible fleet active in May-August, by increasing bike maintenance during these months and scheduling maintenance which requires removal form the road during December.

```{r include = FALSE}
# Line graph by month
nyc_bikes %>% 
  index_by(month) %>% 
  summarise(monthly_usage = n()) %>% 
  ggplot() +
  aes(x = month, y = monthly_usage, group = 1) +
  geom_line() +
  geom_point() +
  labs(
    title = "2018 Bike use by month",
    x = "Month",
    y = "Number of rentals"
  )
```
```{r include = FALSE}
# Bike use by week
nyc_bikes %>% 
  index_by(week) %>% 
  summarise(count = n()) %>% 
  mutate(
    moving_count = slide_dbl(
      count,
      ~ mean(., na.rm = TRUE),
      .before = 2,
      .after = 2
    )
  ) %>% 
  ggplot() +
  aes(x = week, y = moving_count) +
  geom_line() +
  labs(
    title = "2018 bike use by week",
    subtitle = "Smoothed with 4 week average",
    x = "Week of the year",
    y = "Count of usage"
  )
```
```{r include = FALSE}
# Bike use by week
nyc_bikes %>% 
  ggplot() +
  aes(x = week, stat = "count") +
  geom_histogram(bins = 52, col = "white") +
  labs(
    title = "2018 bike use by week",
    x = "Week of the year",
    y = "Usage count"
  )
```
#### Do bike hire patterns differ between bike rider demographics? (e.g. gender, type of trip, age)
```{r}
# patterns: length of trip in time, length of trip in distance(difference lat + difference long), return = start, evening or day usage

# demographics: gender, age, subscriber
```

###### Time of usage
```{r include = FALSE}
# Time of usage compared to age of rider, gender, or subscription type - no patterns
nyc_bikes %>% 
  mutate(time = hour(start_time)) %>% 
  index_by(birth_year) %>% 
  summarise(mean_start_time = mean(as.numeric(time), na.rm = T)) %>% 
  ggplot() +
  aes(x = mean_start_time, y = birth_year) +
  geom_point()
```

No relationship identified between start time and gender, age or subscription status.

###### Trip length
```{r}
nyc_bikes %>% 
  mutate(trip_length = stop_time - start_time) %>% 
  index_by(birth_year) %>% 
  summarise(avg_trip_length = median(trip_length)) %>% 
  ggplot() +
  aes(x = birth_year, y = avg_trip_length) %>% 
  geom_point() +
  labs(
    title = "Trip length by age",
    y = "Trip length",
    x = "Birth year"
  )
```

Does not indicate a relationship between age and trip length. Though it looks like the oldest and youngest users have the longest trip times.

```{r}
# edit to group by gender
nyc_bikes %>% 
  mutate(trip_length = stop_time - start_time) %>% 
  group_by(gender) %>% 
  summarise(avg_trip_length = median(trip_length)) %>% 
  ggplot() +
  aes(x = gender, y = avg_trip_length, fill = gender) + 
  geom_col() +
  labs(
    title = "Average trip length by gender",
    x = "Gender",
    y = "Average trip length"
  )

nyc_bikes %>% 
  mutate(trip_length = stop_time - start_time) %>% 
  mutate(gender_code = case_when(
    gender == "Male" ~ 1,
    gender == "Female" ~ 2,
    gender == "Unknown" ~ 3
  )) %>% 
  index_by(gender_code) %>% 
  summarise(avg_trip_length = median(trip_length)) %>% 
  ggplot() +
  aes(x = gender_code, y = avg_trip_length, fill = gender_code) + 
  geom_col() +
  labs(
    title = "Average trip length by gender",
    x = "Gender",
    y = "Average trip length"
  )

# Check numbers of male, female and unknown gender
# Change x labels
```

From this graph we see that male users have a longer average journey time than women and undisclosed genders.

From this and the user base being greater for men than for women, it seems that Citi Bike may want to invest time and research into why women are not using the Citi Bikes to the same extent as men. Are the bikes comfortable for women? Is the advertising or aesthetic of the bikes more attractive to men than to women?

#### Any other insights?

###### Proportion of users by gender, age and subscription status
```{r include = FALSE}
library(infer)
prop_male_users <- nyc_bikes %>% 
  filter(!gender == "Unknown") %>% 
  specify(response = gender, success = "Male") %>% 
  calculate(stat = "prop")
# observe 0.7

# H0: prop_male_users_popn = 0.7
# Ha: prop_male_users_popn > 0.7
# alpha: 0.05

null_dist_male_users <- nyc_bikes %>% 
  filter(!gender == "Unknown") %>% 
  specify(response = gender, success = "Male") %>% 
  hypothesise(null = "point", p = 0.7) %>% 
  generate(reps = 5000, type = "simulate") %>% 
  calculate(stat = "prop")

p_value_male_users <- get_p_value(null_dist_male_users, obs_stat = prop_male_users, direction = "greater")
# p value 0

```

77% of Citi Bike users with an available gender are male.
A statistical test of whether the proportion of male users in the population is greater than 50% indicated that the proportion of male Citi Bike users is significantly greater than 70%.
For the past few years, New York has had a slightly higher percentage of women than men, which suggests that Citi Bikes is missing out on potential riders.
Citi Bikes may increase hire numbers by targetting more female customers.

```{r include = FALSE}
nyc_bikes %>% 
  specify(response = type, success = "Subscriber") %>% 
  calculate(stat = "prop")
```

92% of Citi Bike hires are conducted by subscribers.

```{r include = FALSE}
nyc_bikes %>% 
  mutate(under_30 = if_else(birth_year < 1990, "under_30", "over_30")) %>% 
  specify(response = under_30, success = "under_30") %>% 
  calculate(stat = "prop")
```

85% of Citi Bike users are under 30.



###### Journey start time
```{r}
nyc_bikes %>% 
  mutate(time = hour(start_time)) %>% 
  index_by(time) %>% 
  summarise(count = n()) %>% 
  ggplot() +
  aes(x = time, y = count) +
  geom_line() +
  labs(
    title = "Most popular start times",
    x = "Time",
    y = "Count"
  )
```

This graph shows us two peaks for the start time of journeys, at 8am and 6pm.

Citi Bikes may want to consider running maintenance between midnight and 5am, when demand for bikes is lowest.
They might also how to ensure coverage and availability at peak times, by running small repairs and redistributing bikes between 10am and 3pm.

###### Used and unused stations
```{r}
# PDA: The visualisations must include geospatial and time series visualisations.
```

##### Are bikes getting even usage


# Conclusions

Peak demand for bikes is from May to August annually, and at 8am and 6pm daily. Citi Bikes may increase bike hire levels by ensuring that there is sufficient availability and coverage during peak times and encouraging additional use during off-peak times through promotions or advertising.

As Citi Bikes have less female customers than male customers and the women have shorter journey lengths than men, Citi Bikes may benefit from research into the comfort of their bikes for women and the attractiveness of their branding towards women.
